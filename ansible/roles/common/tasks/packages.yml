---
- name: Install a default set of packages
  ansible.builtin.apt:
    name: "{{ packages | flatten(levels=1) }}"
    state: present
  tags: packages
  vars:
    packages:
      # YES, we are using systemd!!1!
      - systemd
      - systemd-sysv
      - systemd-resolved
      - zsh
      - vim
      - htop
      - iftop
      - tcpdump
      - ffmpeg
      - git
      - mtr-tiny
      - tmux
      - iperf
      - strace
      - iotop
      - screen
      - build-essential
      - bwm-ng
      - mosh
      - molly-guard
      - ncdu
      - debian-goodies
      - apt-dater-host
      - dnsutils
      - dstat
      - pv
      - buffer
      - lm-sensors
      - moreutils
      - python3
      - ruby
      - ruby-dev
      - libdbi1
      - libdbd-sqlite3
      - ethtool
      - apt-transport-https
      - irqbalance
      - mosquitto-clients
      - zip
      - unzip
      - bc
      - at

# packages for physical hosts
- name: Install packages for physical hosts
  ansible.builtin.apt:
    name:
      - smartmontools
      - lldpd
    state: present
  when: ansible_virtualization_role != 'guest'

- name: Add megacli
  ansible.builtin.apt:
    name: megacli
    state: present
  when: ansible_hostname is match('mebibyte')

# packages for VMs
- name: Install a vmware specific set of packages
  ansible.builtin.apt:
    name: open-vm-tools
    state: present
  when: ansible_virtualization_type is defined and ansible_virtualization_type == 'VMware' and ansible_virtualization_role == 'guest'

- name: Install special packages for VMs
  ansible.builtin.apt:
    name: haveged
    state: present
  when: ansible_virtualization_type is defined and ansible_virtualization_role == 'guest'

- name: Install qemu-aguest-agent
  ansible.builtin.apt:
    name: qemu-guest-agent
    state: present
  when: ansible_virtualization_role == 'guest' and ansible_virtualization_type == 'kvm'

# remove not needed packages
- name: Remove not needed packages
  ansible.builtin.apt:
    name: "{{ packages | flatten(levels=1) }}"
    state: absent
  vars:
    packages:
      - rpcbind
      - openntpd
      - rdnssd
      - dvswitch-voc
      - dvsource-voc
      - dvsink-voc
      - bmdtools
      - check-mk-agent
      - munin-node
      - puppet
  when: "'proxmox' not in group_names"
