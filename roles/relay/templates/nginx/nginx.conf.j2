user  www-data;

# Specifies the value for maximum file descriptors that can be opened by this process.
worker_rlimit_nofile 65536;
# multiple worker
worker_processes  {{ nginx_worker_processes | default('2') }};

error_log  /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
worker_connections  {{ nginx_worker_connections | default('4096') }};

  # required by per_worker
  accept_mutex off;
}

http {
  server_tokens off;

  types_hash_max_size 2048;

  log_format ip '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"';
  access_log /var/log/nginx/access.log ip buffer=128k flush=30s;

  # mime-types
  include /etc/nginx/mime.types;

  # gzip settings
  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 6;
  gzip_min_length  1100;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gzip_types text/plain
             text/css
             text/js
             application/x-javascript
             text/javascript
             application/json;

  # sendfile() copies data between one file descriptor and another.
  # Because this copying is done within the kernel, sendfile() is more
  # efficient than the combination of read(2) and write(2), which would
  # require transferring data to and from user space.
  sendfile on;

  # disable directory listing
  autoindex off;

  # tls defaults
  ssl_protocols         TLSv1.2;
  ssl_ciphers          'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK';
  ssl_dhparam           /etc/ssl/dhparam2048.pem;
  ssl_prefer_server_ciphers on;

  ssl_session_cache   shared:ssl_session_cache:10m;
  ssl_session_timeout 5m;

  ssl_stapling on;
  ssl_stapling_verify on;

  map $http_x_proto $use_https {
      default off;
      https on;
  }

  # vhosts
  include /etc/nginx/sites-enabled/*;
}
